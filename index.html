<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinPost Terminal 抽選アプリ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #000000 50%, #1f2937 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .glass-panel {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 32px;
            text-align: center;
        }

        .header {
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 4rem);
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header h2 {
            font-size: clamp(1.2rem, 3vw, 2rem);
            color: #d1d5db;
            margin-bottom: 8px;
        }

        .header p {
            color: #9ca3af;
            font-size: clamp(0.9rem, 2vw, 1.1rem);
        }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.7);
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-2px);
        }

        .icon-btn svg {
            width: 24px;
            height: 24px;
        }

        .lottery-section {
            max-width: 500px;
            width: 100%;
        }

        .gift-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 24px;
            color: #60a5fa;
        }

        .draw-button {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            border-radius: 50px;
            padding: 20px 40px;
            font-size: clamp(1rem, 2.5vw, 1.5rem);
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
        }

        .draw-button:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.4);
        }

        .draw-button:active:not(:disabled) {
            transform: translateY(-1px) scale(0.98);
        }

        .draw-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .countdown {
            font-size: 8rem;
            font-weight: 900;
            color: #60a5fa;
            animation: pulse 1s infinite;
            margin: 40px 0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .result-section {
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .result-title {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 800;
            margin-bottom: 16px;
            position: relative;
            z-index: 15;
        }

        .prize-name {
            font-size: clamp(1.2rem, 3vw, 2rem);
            font-weight: 600;
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid #60a5fa;
            border-radius: 16px;
            color: #bfdbfe;
            position: relative;
            z-index: 15;
        }

        .reset-button {
            background: #6b7280;
            border: none;
            border-radius: 50px;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 15;
        }

        .reset-button:hover {
            background: #4b5563;
            transform: translateY(-2px);
        }

        .prize-colors {
            --first: linear-gradient(135deg, #fbbf24, #f59e0b);
            --second: linear-gradient(135deg, #d1d5db, #9ca3af);
            --third: linear-gradient(135deg, #fb923c, #ea580c);
            --fourth: linear-gradient(135deg, #60a5fa, #3b82f6);
        }

        .prize-first { background: var(--first); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .prize-second { background: var(--second); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .prize-third { background: var(--third); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .prize-fourth { background: var(--fourth); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* 等級別の当選画面スタイル */
        .winner-first {
            background: transparent;
            border: 3px solid #fbbf24;
            box-shadow: 0 0 40px rgba(251, 191, 36, 0.4);
            animation: goldenGlow 2s infinite alternate;
        }

        .winner-second {
            background: transparent;
            border: 3px solid #d1d5db;
            box-shadow: 0 0 30px rgba(209, 213, 219, 0.3);
            animation: silverGlow 2s infinite alternate;
        }

        .winner-third {
            background: transparent;
            border: 3px solid #fb923c;
            box-shadow: 0 0 25px rgba(251, 146, 60, 0.3);
            animation: bronzeGlow 2s infinite alternate;
        }

        .winner-fourth {
            background: transparent;
            border: 2px solid #60a5fa;
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.2);
        }

        @keyframes goldenGlow {
            0% { box-shadow: 0 0 40px rgba(251, 191, 36, 0.4); }
            100% { box-shadow: 0 0 55px rgba(251, 191, 36, 0.6); }
        }

        @keyframes silverGlow {
            0% { box-shadow: 0 0 30px rgba(209, 213, 219, 0.3); }
            100% { box-shadow: 0 0 45px rgba(209, 213, 219, 0.5); }
        }

        @keyframes bronzeGlow {
            0% { box-shadow: 0 0 25px rgba(251, 146, 60, 0.3); }
            100% { box-shadow: 0 0 35px rgba(251, 146, 60, 0.5); }
        }

        .winner-first .result-title {
            font-size: clamp(2.5rem, 6vw, 4rem);
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
            color: white;
            font-weight: 800;
            position: relative;
            z-index: 20;
        }

        .winner-second .result-title {
            font-size: clamp(2.2rem, 5vw, 3.5rem);
            text-shadow: 0 0 12px rgba(209, 213, 219, 0.6);
            color: white;
            font-weight: 800;
            position: relative;
            z-index: 20;
        }

        .winner-third .result-title {
            font-size: clamp(2rem, 4.5vw, 3rem);
            text-shadow: 0 0 8px rgba(251, 146, 60, 0.6);
            color: white;
            font-weight: 800;
            position: relative;
            z-index: 20;
        }

        .winner-fourth .result-title {
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            color: white;
            font-weight: 800;
            position: relative;
            z-index: 20;
        }

        .winner-first .prize-number {
            font-size: clamp(3rem, 7vw, 5rem);
            font-weight: 900;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
            margin: 20px 0;
            color: white;
            position: relative;
            z-index: 20;
        }

        .winner-second .prize-number {
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 800;
            text-shadow: 0 0 15px rgba(209, 213, 219, 0.8);
            margin: 16px 0;
            color: white;
            position: relative;
            z-index: 20;
        }

        .winner-third .prize-number {
            font-size: clamp(2.2rem, 5vw, 3.5rem);
            font-weight: 700;
            text-shadow: 0 0 10px rgba(251, 146, 60, 0.8);
            margin: 14px 0;
            color: white;
            position: relative;
            z-index: 20;
        }

        .winner-fourth .prize-number {
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 700;
            margin: 16px 0;
            color: white;
            position: relative;
            z-index: 20;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confetti-fall 3s linear infinite;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .reset-section {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-top: 32px;
        }

        .reset-section h3 {
            color: #ef4444;
            margin-bottom: 16px;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .reset-section p {
            color: #fca5a5;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .reset-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            margin-bottom: 16px;
        }

        .reset-input:focus {
            outline: none;
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .reset-input::placeholder {
            color: #fca5a5;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #b91c1c;
        }

        .btn-danger:disabled {
            background: #6b7280;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .language-selector {
            max-width: 400px;
            width: 100%;
        }

        .language-selector h2 {
            font-size: 1.5rem;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .language-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .language-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 16px 24px;
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .language-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .staff-login {
            max-width: 400px;
            width: 100%;
        }

        .staff-login h2 {
            font-size: 1.5rem;
            margin-bottom: 24px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        .form-group input::placeholder {
            color: #9ca3af;
        }

        .button-group {
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .staff-panel {
            max-width: 1200px;
            width: 100%;
            padding: 20px;
        }

        .staff-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .staff-header h1 {
            font-size: 2rem;
            font-weight: 800;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #60a5fa;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #d1d5db;
            font-size: 0.9rem;
        }

        .prizes-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .prizes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .prizes-list {
            display: grid;
            gap: 12px;
        }

        .prize-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .prize-item-name {
            font-weight: 600;
        }

        .prize-item-count {
            font-weight: 700;
        }

        .prize-item-count.available {
            color: #10b981;
        }

        .prize-item-count.unavailable {
            color: #ef4444;
        }

        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .history-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .history-number {
            width: 32px;
            height: 32px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .remaining-display {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-top: 32px;
            max-width: 500px;
            width: 100%;
        }

        .remaining-display h3 {
            text-align: center;
            margin-bottom: 16px;
            font-size: 1.2rem;
        }

        .remaining-list {
            display: grid;
            gap: 8px;
        }

        .remaining-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
        }

        .remaining-total {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 12px;
            padding-top: 12px;
            text-align: center;
            color: #d1d5db;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 12px;
            color: #fecaca;
            margin-top: 12px;
            text-align: center;
        }

        .logo {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            overflow: hidden;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .glass-panel {
                padding: 20px;
            }
            
            .staff-panel {
                padding: 12px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .staff-header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- 初期読み込み画面 -->
        <div id="loading" class="glass-panel">
            <div class="logo">
                <img src="cpt_logo_white.png" alt="CoinPost Terminal Logo" onerror="this.style.display='none'">
            </div>
            <h2>読み込み中...</h2>
            <p>Firebase に接続しています</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase設定 - ここに実際の設定値を入力してください
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, runTransaction } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // ⭐ TODO: Firebase プロジェクトの設定に置き換えてください
        const firebaseConfig = {
            apiKey: "AIzaSyCvqN-HYSI56RgfLoTilf4jQY6zjrnttG0",
            authDomain: "webxgiveaway.firebaseapp.com",
            databaseURL: "https://webxgiveaway-default-rtdb.firebaseio.com",
            projectId: "webxgiveaway",
            storageBucket: "webxgiveaway.firebasestorage.app",
            messagingSenderId: "613770112471",
            appId: "1:613770112471:web:8e5db3ac51de11e9a4ef92"
        };

        // Firebase初期化
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // 多言語対応
        const translations = {
            ja: {
                title: "CoinPost Terminal",
                subtitle: "登録記念くじ引き",
                description: "登録していただいた方限定の特別抽選です！",
                clickToStart: "ボタンを押してくじ引き開始！",
                startButton: "くじ引きスタート！",
                congratulations: "おめでとうございます！",
                showStaff: "スタッフまで当選画面をお見せください",
                resetScreen: "画面をリセット",
                thankYou: "CoinPost Terminal への登録ありがとうございます！",
                enjoy: "最新の暗号資産情報をお楽しみください",
                prizes: {
                    first: "1等：ハードウェアウォレット",
                    second: "2等：CoinPost 限定グッズセット",
                    third: "3等：CoinPost ステッカーセット",
                    fourth: "4等：CoinPost ロゴ入りボールペン",
                },
                prizeNumbers: {
                    first: "1等",
                    second: "2等",
                    third: "3等",
                    fourth: "4等"
                },
                staff: {
                    title: "スタッフ操作画面",
                    password: "パスワード",
                    login: "ログイン",
                    wrongPassword: "パスワードが間違っています",
                    back: "戻る",
                    cancel: "キャンセル",
                    totalDraws: "総抽選回数",
                    remaining: "残り賞品数",
                    showRemaining: "残り個数を表示",
                    hideRemaining: "残り個数を隠す",
                    resetData: "データリセット",
                    resetWarning: "全ての抽選データ（履歴・残り個数）がリセットされます。この操作は取り消せません。",
                    resetConfirm: "本当にリセットする場合は「reset」と入力してください",
                    resetPlaceholder: "reset と入力",
                    resetButton: "データをリセット",
                },
            },
            en: {
                title: "CoinPost Terminal",
                subtitle: "Registration Lucky Draw",
                description: "Special lottery exclusive for registered users!",
                clickToStart: "Press the button to start the draw!",
                startButton: "Start Lucky Draw!",
                congratulations: "Congratulations!",
                showStaff: "Please show this screen to our staff",
                resetScreen: "Reset Screen",
                thankYou: "Thank you for registering with CoinPost Terminal!",
                enjoy: "Enjoy the latest crypto information",
                prizes: {
                    first: "1st Prize: Hardware Wallet",
                    second: "2nd Prize: CoinPost Limited Goods Set",
                    third: "3rd Prize: CoinPost Sticker Set",
                    fourth: "4th Prize: CoinPost Logo Pen",
                },
                prizeNumbers: {
                    first: "1st Prize",
                    second: "2nd Prize",
                    third: "3rd Prize",
                    fourth: "4th Prize"
                },
                staff: {
                    title: "Staff Control Panel",
                    password: "Password",
                    login: "Login",
                    wrongPassword: "Wrong password",
                    back: "Back",
                    cancel: "Cancel",
                    totalDraws: "Total Draws",
                    remaining: "Remaining Prizes",
                    showRemaining: "Show Remaining Count",
                    hideRemaining: "Hide Remaining Count",
                    resetData: "Reset Data",
                    resetWarning: "All lottery data (history and remaining counts) will be reset. This action cannot be undone.",
                    resetConfirm: "Type 'reset' to confirm reset",
                    resetPlaceholder: "Type reset",
                    resetButton: "Reset Data",
                },
            },
            zh: {
                title: "CoinPost Terminal",
                subtitle: "注册纪念抽奖",
                description: "仅限注册用户的特别抽奖！",
                clickToStart: "按下按钮开始抽奖！",
                startButton: "开始抽奖！",
                congratulations: "恭喜您！",
                showStaff: "请向工作人员出示此中奖画面",
                resetScreen: "重置屏幕",
                thankYou: "感谢您注册 CoinPost Terminal！",
                enjoy: "享受最新的加密货币信息",
                prizes: {
                    first: "一等奖：硬件钱包",
                    second: "二等奖：CoinPost 限定商品套装",
                    third: "三等奖：CoinPost 贴纸套装",
                    fourth: "四等奖：CoinPost 标志圆珠笔",
                },
                prizeNumbers: {
                    first: "一等奖",
                    second: "二等奖",
                    third: "三等奖",
                    fourth: "四等奖"
                },
                staff: {
                    title: "工作人员控制面板",
                    password: "密码",
                    login: "登录",
                    wrongPassword: "密码错误",
                    back: "返回",
                    cancel: "取消",
                    totalDraws: "总抽奖次数",
                    remaining: "剩余奖品数",
                    showRemaining: "显示剩余数量",
                    hideRemaining: "隐藏剩余数量",
                    resetData: "重置数据",
                    resetWarning: "所有抽奖数据（历史记录和剩余数量）将被重置。此操作无法撤销。",
                    resetConfirm: "如要确认重置，请输入「reset」",
                    resetPlaceholder: "输入 reset",
                    resetButton: "重置数据",
                },
            },
        };

        // アプリケーション状態
        let currentLanguage = null;
        let isStaff = false;
        let showRemaining = false;
        let isDrawing = false;
        let currentResult = null;
        let countDown = 0;
        let prizes = {};
        let totalDrawn = 0;
        let winnerHistory = [];

        // Firebase データ初期化
        async function initializeData() {
            const dataRef = ref(database, 'lottery');
            const snapshot = await get(dataRef);
            
            if (!snapshot.exists()) {
                // 初期データを設定
                const initialData = {
                    prizes: {
                        first: { count: 2, remaining: 2 },
                        second: { count: 10, remaining: 10 },
                        third: { count: 50, remaining: 50 },
                        fourth: { count: 200, remaining: 200 }
                    },
                    totalDrawn: 0,
                    winnerHistory: []
                };
                await set(dataRef, initialData);
            }
        }

        // データリスナーを設定
        function setupDataListeners() {
            const dataRef = ref(database, 'lottery');
            onValue(dataRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    prizes = data.prizes || {};
                    totalDrawn = data.totalDrawn || 0;
                    winnerHistory = data.winnerHistory || [];
                    
                    // UI更新
                    if (isStaff) {
                        updateStaffPanel();
                    }
                    if (showRemaining) {
                        updateRemainingDisplay();
                    }
                }
            });
        }

        // 抽選実行
        async function drawLottery() {
            if (isDrawing) return;

            const dataRef = ref(database, 'lottery');
            
            try {
                await runTransaction(dataRef, (currentData) => {
                    if (currentData === null) {
                        return {
                            prizes: {
                                first: { count: 2, remaining: 2 },
                                second: { count: 10, remaining: 10 },
                                third: { count: 50, remaining: 50 },
                                fourth: { count: 200, remaining: 200 }
                            },
                            totalDrawn: 0,
                            winnerHistory: []
                        };
                    }

                    const availablePrizes = Object.entries(currentData.prizes).filter(
                        ([_, prize]) => prize.remaining > 0
                    );

                    if (availablePrizes.length === 0) {
                        throw new Error('no_prizes');
                    }

                    // 重み付き抽選
                    const weights = { first: 1, second: 5, third: 15, fourth: 30 };
                    let totalWeight = 0;
                    const weightedPrizes = [];

                    availablePrizes.forEach(([key, prize]) => {
                        if (prize.remaining > 0) {
                            const weight = weights[key];
                            totalWeight += weight;
                            weightedPrizes.push({ key, weight: totalWeight });
                        }
                    });

                    const random = Math.random() * totalWeight;
                    let selectedPrize = 'fourth';

                    for (const prize of weightedPrizes) {
                        if (random <= prize.weight) {
                            selectedPrize = prize.key;
                            break;
                        }
                    }

                    // データ更新
                    currentData.prizes[selectedPrize].remaining--;
                    currentData.totalDrawn = (currentData.totalDrawn || 0) + 1;
                    
                    const newWinner = {
                        id: Date.now(),
                        prize: selectedPrize,
                        timestamp: new Date().toLocaleString()
                    };
                    
                    if (!currentData.winnerHistory) {
                        currentData.winnerHistory = [];
                    }
                    currentData.winnerHistory.unshift(newWinner);

                    return currentData;
                });

                // 抽選アニメーション開始
                startDrawingAnimation();
                
            } catch (error) {
                if (error.message === 'no_prizes') {
                    alert(getTranslation('noPrizes'));
                } else {
                    console.error('抽選エラー:', error);
                    alert('エラーが発生しました。もう一度お試しください。');
                }
            }
        }

        // 抽選アニメーション
        function startDrawingAnimation() {
            isDrawing = true;
            countDown = 3;
            updateMainScreen();

            const countdownInterval = setInterval(() => {
                countDown--;
                updateMainScreen();
                
                if (countDown <= 0) {
                    clearInterval(countdownInterval);
                    // 最新の当選結果を取得
                    if (winnerHistory.length > 0) {
                        currentResult = winnerHistory[0].prize;
                    }
                    isDrawing = false;
                    updateMainScreen();
                }
            }, 1000);
        }

        // 翻訳取得
        function getTranslation(key) {
            const t = translations[currentLanguage] || translations.ja;
            const keys = key.split('.');
            let result = t;
            for (const k of keys) {
                result = result[k];
                if (!result) break;
            }
            return result || key;
        }

        // SVGアイコン
        const icons = {
            gift: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="20,12 20,22 4,22 4,12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="m5,7 0,0a2,2 0 0,1 0,-4c1.1,0 3,1.1 3,3v1"></path><path d="m19,7 0,0a2,2 0 0,0 0,-4c-1.1,0 -3,1.1 -3,3v1"></path></svg>`,
            globe: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`,
            users: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`
        };

        // メイン画面更新
        function updateMainScreen() {
            const app = document.getElementById('app');
            const t = translations[currentLanguage] || translations.ja;

            let content = `
                <div class="controls">
                    <button class="icon-btn" onclick="showLanguageSelector()">${icons.globe}</button>
                    <button class="icon-btn" onclick="showStaffLogin()">${icons.users}</button>
                </div>

                <div class="header">
                    <h1>${t.title}</h1>
                    <h2>${t.subtitle}</h2>
                    <p>${t.description}</p>
                </div>

                <div class="glass-panel lottery-section">
            `;

            if (!currentResult && !isDrawing) {
                content += `
                    <div class="gift-icon">${icons.gift}</div>
                    <p style="font-size: 1.2rem; margin-bottom: 24px; color: #d1d5db;">${t.clickToStart || 'ボタンを押してくじ引き開始！'}</p>
                    <button class="draw-button" onclick="drawLottery()" ${isDrawing ? 'disabled' : ''}>
                        ${t.startButton}
                    </button>
                `;
            } else if (isDrawing && countDown > 0) {
                content += `
                    <div class="countdown">${countDown}</div>
                `;
            } else if (currentResult) {
                const prizeNames = {
                    first: t.prizes.first,
                    second: t.prizes.second,
                    third: t.prizes.third,
                    fourth: t.prizes.fourth
                };
                
                const prizeNumbers = {
                    first: t.prizeNumbers.first,
                    second: t.prizeNumbers.second,
                    third: t.prizeNumbers.third,
                    fourth: t.prizeNumbers.fourth
                };

                content += `
                    <div class="result-section">
                        <h3 class="result-title">${t.congratulations}</h3>
                        <p class="prize-number">${prizeNumbers[currentResult]}</p>
                        <div class="prize-name">${t.showStaff}</div>
                        <button class="reset-button" onclick="resetScreen()">${t.resetScreen}</button>
                    </div>
                `;
            }

            content += `</div>`;


            if (showRemaining) {
                content += `
                    <div class="remaining-display">
                        <h3>${t.staff.remaining}</h3>
                        <div class="remaining-list">
                `;
                
                Object.entries(prizes).forEach(([key, prize]) => {
                    const prizeNames = {
                        first: t.prizeNumbers.first,
                        second: t.prizeNumbers.second, 
                        third: t.prizeNumbers.third,
                        fourth: t.prizeNumbers.fourth
                    };
                    
                    content += `
                        <div class="remaining-item">
                            <span>${prizeNames[key]}</span>
                            <span class="prize-item-count ${prize.remaining > 0 ? 'available' : 'unavailable'}">
                                ${prize.remaining}/${prize.count}
                            </span>
                        </div>
                    `;
                });

                content += `
                        </div>
                        <div class="remaining-total">${t.staff.totalDraws}: ${totalDrawn}</div>
                    </div>
                `;
            }

            content += `
                <div style="margin-top: 32px; text-align: center; color: #9ca3af; font-size: 0.9rem;">
                    <p>${t.thankYou}</p>
                    <p>${t.enjoy}</p>
                </div>
            `;

            app.innerHTML = content;

            // 等級別のクラス追加とコンフェッティ効果（DOM更新後に実行）
            if (currentResult) {
                setTimeout(() => {
                    const lotterySection = document.querySelector('.lottery-section');
                    if (lotterySection) {
                        lotterySection.className = `glass-panel lottery-section winner-${currentResult}`;
                        
                        // 1等の場合のみコンフェッティ効果
                        if (currentResult === 'first') {
                            addConfetti();
                        }
                    }
                }, 10);
            }
        }

        // 言語選択画面
        function showLanguageSelector() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="logo">
                    <img src="cpt_logo_white.png" alt="CoinPost Terminal Logo" onerror="this.style.display='none'">
                </div>
                <h1 style="font-size: 3rem; font-weight: 800; margin-bottom: 8px; background: linear-gradient(135deg, #60a5fa, #3b82f6); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">CoinPost Terminal</h1>
                <p style="color: #d1d5db; font-size: 1.2rem; margin-bottom: 40px;">Registration Lucky Draw</p>

                <div class="glass-panel language-selector">
                    <h2>${icons.globe} Select Language</h2>
                    <div class="language-buttons">
                        <button class="language-btn" onclick="setLanguage('ja')">日本語</button>
                        <button class="language-btn" onclick="setLanguage('en')">English</button>
                        <button class="language-btn" onclick="setLanguage('zh')">中文</button>
                    </div>
                </div>
            `;
        }

        // 言語設定
        function setLanguage(lang) {
            currentLanguage = lang;
            updateMainScreen();
        }

        // スタッフログイン画面
        function showStaffLogin() {
            const app = document.getElementById('app');
            const t = translations[currentLanguage] || translations.ja;
            
            app.innerHTML = `
                <div class="glass-panel staff-login">
                    <h2>${t.staff.title}</h2>
                    <div class="form-group">
                        <label>${t.staff.password}</label>
                        <input type="password" id="staffPassword" placeholder="****" onkeypress="handlePasswordKeypress(event)">
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="handleStaffLogin()">${t.staff.login}</button>
                        <button class="btn btn-secondary" onclick="updateMainScreen()">${t.staff.cancel}</button>
                    </div>
                    <div id="loginError"></div>
                </div>
            `;
        }

        // パスワード入力処理
        function handlePasswordKeypress(event) {
            if (event.key === 'Enter') {
                handleStaffLogin();
            }
        }

        // スタッフログイン処理
        function handleStaffLogin() {
            const password = document.getElementById('staffPassword').value;
            const t = translations[currentLanguage] || translations.ja;
            
            if (password === '1234') {
                isStaff = true;
                showStaffPanel();
            } else {
                document.getElementById('loginError').innerHTML = `
                    <div class="error-message">${t.staff.wrongPassword}</div>
                `;
            }
        }

        // スタッフパネル表示
        function showStaffPanel() {
            const app = document.getElementById('app');
            const t = translations[currentLanguage] || translations.ja;

            let content = `
                <div class="staff-panel">
                    <div class="staff-header">
                        <h1>${t.staff.title}</h1>
                        <button class="btn btn-secondary" onclick="exitStaffMode()">${t.staff.back}</button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${totalDrawn}</div>
                            <div class="stat-label">${t.staff.totalDraws}</div>
                        </div>
                    </div>

                    <div class="prizes-section">
                        <div class="prizes-header">
                            <h2>${t.staff.remaining}</h2>
                            <button class="btn ${showRemaining ? 'btn-primary' : 'btn-secondary'}" onclick="toggleRemaining()">
                                ${showRemaining ? t.staff.hideRemaining : t.staff.showRemaining}
                            </button>
                        </div>
                        <div class="prizes-list">
            `;

            const prizeLabels = {
                first: t.prizeNumbers.first,
                second: t.prizeNumbers.second,
                third: t.prizeNumbers.third, 
                fourth: t.prizeNumbers.fourth
            };

            Object.entries(prizes).forEach(([key, prize]) => {
                content += `
                    <div class="prize-item">
                        <span class="prize-item-name">${prizeLabels[key]}</span>
                        <span class="prize-item-count ${prize.remaining > 0 ? 'available' : 'unavailable'}">
                            ${prize.remaining}/${prize.count}
                        </span>
                    </div>
                `;
            });

            content += `
                        </div>
                    </div>

                    <div class="history-section">
                        <h2>当選履歴</h2>
            `;

            if (winnerHistory.length === 0) {
                content += `
                    <div style="text-center; padding: 40px; color: #9ca3af;">
                        まだ当選者がいません
                    </div>
                `;
            } else {
                content += `<div class="history-list">`;
                winnerHistory.forEach((winner, index) => {
                    const prizeLabels = {
                        first: t.prizeNumbers.first,
                        second: t.prizeNumbers.second,
                        third: t.prizeNumbers.third,
                        fourth: t.prizeNumbers.fourth
                    };
                    
                    content += `
                        <div class="history-item">
                            <div class="history-item-left">
                                <div class="history-number">${index + 1}</div>
                                <span>${prizeLabels[winner.prize]}</span>
                            </div>
                            <div style="color: #d1d5db; font-size: 0.9rem;">${winner.timestamp}</div>
                        </div>
                    `;
                });
                content += `</div>`;
            }

            content += `
                    </div>

                    <div class="reset-section">
                        <h3>${t.staff.resetData}</h3>
                        <p>${t.staff.resetWarning}</p>
                        <p style="font-size: 0.8rem; color: #fca5a5; margin-bottom: 12px;">${t.staff.resetConfirm}</p>
                        <input type="text" id="resetInput" class="reset-input" placeholder="${t.staff.resetPlaceholder}" oninput="checkResetInput()">
                        <button id="resetButton" class="btn btn-danger" onclick="resetAllData()" disabled>
                            ${t.staff.resetButton}
                        </button>
                    </div>
                </div>
            `;

            app.innerHTML = content;
        }

        // スタッフパネル更新
        function updateStaffPanel() {
            if (isStaff) {
                showStaffPanel();
            }
        }

        // 残り個数表示更新
        function updateRemainingDisplay() {
            if (showRemaining && !isStaff) {
                updateMainScreen();
            }
        }

        // スタッフモード終了
        function exitStaffMode() {
            isStaff = false;
            updateMainScreen();
        }

        // 残り個数表示切り替え
        function toggleRemaining() {
            showRemaining = !showRemaining;
            if (isStaff) {
                showStaffPanel();
            } else {
                updateMainScreen();
            }
        }

        // コンフェッティ効果
        function addConfetti() {
            const colors = ['#fbbf24', '#f59e0b', '#fcd34d', '#fed7aa', '#fde68a'];
            const container = document.querySelector('.container');
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 3 + 's';
                    confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    container.appendChild(confetti);
                    
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }, i * 100);
            }
        }

        // リセット入力チェック
        function checkResetInput() {
            const input = document.getElementById('resetInput');
            const button = document.getElementById('resetButton');
            if (input && button) {
                button.disabled = input.value !== 'reset';
            }
        }

        // 全データリセット
        async function resetAllData() {
            const input = document.getElementById('resetInput');
            if (input.value !== 'reset') {
                return;
            }

            try {
                const initialData = {
                    prizes: {
                        first: { count: 1, remaining: 1 },
                        second: { count: 100, remaining: 100 },
                        third: { count: 1000, remaining: 1000 },
                        fourth: { count: 0, remaining: 0 }
                    },
                    totalDrawn: 0,
                    winnerHistory: []
                };

                const dataRef = ref(database, 'lottery');
                await set(dataRef, initialData);
                
                // 入力フィールドをクリア
                input.value = '';
                checkResetInput();
                
                alert('データがリセットされました。');
                
            } catch (error) {
                console.error('リセットエラー:', error);
                alert('リセット中にエラーが発生しました。');
            }
        }

        // 画面リセット
        function resetScreen() {
            currentResult = null;
            updateMainScreen();
        }

        // グローバル関数として定義
        window.drawLottery = drawLottery;
        window.showLanguageSelector = showLanguageSelector;
        window.setLanguage = setLanguage;
        window.showStaffLogin = showStaffLogin;
        window.handlePasswordKeypress = handlePasswordKeypress;
        window.handleStaffLogin = handleStaffLogin;
        window.exitStaffMode = exitStaffMode;
        window.toggleRemaining = toggleRemaining;
        window.resetScreen = resetScreen;
        window.checkResetInput = checkResetInput;
        window.resetAllData = resetAllData;

        // アプリ初期化
        async function initApp() {
            try {
                await initializeData();
                setupDataListeners();
                
                // 読み込み完了後、言語選択画面を表示
                setTimeout(() => {
                    showLanguageSelector();
                }, 1000);
                
            } catch (error) {
                console.error('Firebase初期化エラー:', error);
                document.getElementById('app').innerHTML = `
                    <div class="glass-panel">
                        <h2 style="color: #ef4444; margin-bottom: 16px;">接続エラー</h2>
                        <p style="margin-bottom: 16px;">Firebase の設定を確認してください。</p>
                        <p style="font-size: 0.9rem; color: #9ca3af;">
                            firebaseConfig の設定値が正しく入力されているか確認してください。
                        </p>
                        <button class="btn btn-primary" style="margin-top: 20px;" onclick="location.reload()">
                            再読み込み
                        </button>
                    </div>
                `;
            }
        }

        // アプリ開始
        initApp();
    </script>
</body>
</html>
